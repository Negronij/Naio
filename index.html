<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Naio - Inicio</title>
<link rel="icon" href="Naio.png">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCmzxzDSJFPt7-fDti1PRC-boDE30cJEbM",
  authDomain: "naio1092ngs.firebaseapp.com",
  projectId: "naio1092ngs",
  storageBucket: "naio1092ngs.firebasestorage.app",
  messagingSenderId: "874452485775",
  appId: "1:874452485775:web:25e5ed586fcebe93e952fa",
  measurementId: "G-JBK153N8XL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Login con Google
window.loginWithGoogle = () => {
  const provider = new GoogleAuthProvider();
  signInWithPopup(auth, provider)
    .then((result) => {
      document.getElementById('login').style.display = 'none';
      document.getElementById('lobby').style.display = 'flex';
      document.getElementById('usuarioNombre').textContent = result.user.displayName;
    })
    .catch(err => console.error(err));
}

// Función para crear sala
window.crearSala = () => {
  const user = auth.currentUser;
  if(!user) return alert("Debes iniciar sesión primero");

  const codigo = Math.random().toString(36).substring(2,8).toUpperCase();
  const salaRef = ref(db, 'salas/' + codigo);
  
  set(salaRef, {
    codigo: codigo,
    usuarios: {
      [user.uid]: user.displayName
    }
  }).then(()=>{
    // Redirigir a call.html con el código de sala
    window.location.href = `call.html?codigo=${codigo}`;
  }).catch(err => console.error(err));
}

// Función para unirse a sala
window.unirseSala = () => {
  const codigo = document.getElementById('codigoSala').value.toUpperCase();
  const user = auth.currentUser;
  if(!user) return alert("Debes iniciar sesión primero");
  if(!codigo) return alert("Ingresa un código de sala");

  const salaRef = ref(db, 'salas/' + codigo);
  get(salaRef).then(snapshot => {
    if(snapshot.exists()){
      // Agregar usuario a la sala
      set(ref(db,'salas/'+codigo+'/usuarios/'+user.uid), user.displayName)
        .then(()=> {
          window.location.href = `call.html?codigo=${codigo}`;
        });
    } else alert("Sala no encontrada");
  });
}
</script>
<style>
body { margin:0; font-family: Arial; background:#0f0f1a; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
#login, #lobby { display:none; flex-direction:column; align-items:center; gap:20px; }
button { padding:10px 20px; border:none; border-radius:8px; background:#4285F4; color:#fff; cursor:pointer; font-size:16px; display:flex; align-items:center; gap:8px; }
input { padding:8px; border-radius:6px; border:none; font-size:16px; text-align:center; }
</style>
</head>
<body>

<!-- Login con Google -->
<div id="login">
  <button onclick="loginWithGoogle()">
    <img src="google.png" alt="Google Logo" style="height:24px;">
    Iniciar sesión con Google
  </button>
</div>

<!-- Lobby: crear o unirse a sala -->
<div id="lobby">
  <h2>Bienvenido <span id="usuarioNombre"></span></h2>
  <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
    <button onclick="crearSala()">Crear Sala</button>
    <div>
      <input type="text" id="codigoSala" placeholder="Código de sala">
      <button onclick="unirseSala()">Unirse a Sala</button>
    </div>
  </div>
</div>

<script>
  // Mostrar login al inicio
  document.getElementById('login').style.display = 'flex';
</script>
</body>
</html>
