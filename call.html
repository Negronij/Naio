<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Naio - Llamada</title>
<link rel="icon" href="Naio.png">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, onChildAdded, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCmzxzDSJFPt7-fDti1PRC-boDE30cJEbM",
  authDomain: "naio1092ngs.firebaseapp.com",
  projectId: "naio1092ngs",
  storageBucket: "naio1092ngs.firebasestorage.app",
  messagingSenderId: "874452485775",
  appId: "1:874452485775:web:25e5ed586fcebe93e952fa",
  measurementId: "G-JBK153N8XL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Usuario logueado
let user;
auth.onAuthStateChanged(u=>{
  if(!u) window.location.href="index.html";
  else user=u;
});

// CÃ³digo de sala desde query string
const urlParams = new URLSearchParams(window.location.search);
const codigoSala = urlParams.get('codigo');
if(!codigoSala) alert("CÃ³digo de sala no especificado");

// Config WebRTC
const localConnections = {}; // peerId => RTCPeerConnection
const remoteStreams = {};    // peerId => MediaStream
const videoElements = {};    // peerId => video HTML element

let localStream;
let micOn=true, cameraOn=true;

// Obtener cÃ¡mara y micrÃ³fono
async function initMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  addVideo(user.displayName, localStream, true);
}
initMedia();

// UI
const videosDiv = document.getElementById('videos');
const extraDiv = document.getElementById('extraUsers');
const showMoreBtn = document.getElementById('showMore');
document.getElementById('salaCodigo').textContent = codigoSala;

document.getElementById('toggleCamera').addEventListener('click',()=>{
  cameraOn=!cameraOn;
  localStream.getVideoTracks().forEach(t=>t.enabled=cameraOn);
  const localVid = videosDiv.querySelector('video');
  if(localVid) localVid.style.display=cameraOn?'block':'none';
});
document.getElementById('toggleMic').addEventListener('click',()=>{
  micOn=!micOn;
  localStream.getAudioTracks().forEach(t=>t.enabled=micOn);
  document.body.classList.toggle('muted',!micOn);
});
showMoreBtn.addEventListener('click',()=>{
  extraDiv.style.display = extraDiv.style.display==='flex'?'none':'flex';
  showMoreBtn.textContent = extraDiv.style.display==='flex'?'Cerrar':'MÃ¡s';
});

// Crear o unirse a sala
const salaRef = ref(db,'salas/'+codigoSala+'/usuarios/'+user.uid);
set(salaRef,user.displayName);
window.addEventListener('beforeunload',()=>remove(salaRef));

// Agregar video local o placeholder
function addVideo(nombre, stream=null, isLocal=false){
  const container = document.createElement('div');
  container.classList.add('video-container');

  let vid, placeholder;
  if(stream){
    vid = document.createElement('video');
    vid.autoplay=true;
    vid.muted=isLocal;
    vid.srcObject=stream;
    container.appendChild(vid);
  } else {
    placeholder = document.createElement('div');
    placeholder.classList.add('name-placeholder');
    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    avatar.textContent = nombre[0].toUpperCase();
    placeholder.appendChild(avatar);
    const nameDiv = document.createElement('div');
    nameDiv.textContent=nombre;
    placeholder.appendChild(nameDiv);
    container.appendChild(placeholder);
  }

  const usernameDiv = document.createElement('div');
  usernameDiv.classList.add('username');
  usernameDiv.textContent=nombre;
  container.appendChild(usernameDiv);

  const overlay = document.createElement('div');
  overlay.classList.add('overlay');
  container.appendChild(overlay);

  videoElements[nombre]=container;
  return container;
}

// Actualizar UI con mÃ¡ximo 4 personas visibles
function updateUsersUI(usuarios){
  videosDiv.innerHTML=''; extraDiv.innerHTML='';
  const keys = Object.keys(usuarios);
  keys.forEach((uid,i)=>{
    if(uid===user.uid) videosDiv.appendChild(videoElements[usuarios[uid]] || addVideo(usuarios[uid], localStream,true));
    else{
      const vidElem = videoElements[usuarios[uid]] || addVideo(usuarios[uid], null,false);
      if(i<4) videosDiv.appendChild(vidElem);
      else extraDiv.appendChild(vidElem);
    }
  });
  showMoreBtn.classList.toggle('hidden', keys.length<=4);
}

// Escuchar cambios en sala
const salaUsuariosRef = ref(db,'salas/'+codigoSala+'/usuarios');
onValue(salaUsuariosRef, snapshot=>{
  const usuarios = snapshot.val();
  if(!usuarios) return;
  updateUsersUI(usuarios);
});

// WebRTC â€“ seÃ±alizaciÃ³n via Firebase
const signalsRef = ref(db,'salas/'+codigoSala+'/signals/'+user.uid);
const peerConfig = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

// Escuchar ofertas de otros usuarios
const allSignalsRef = ref(db,'salas/'+codigoSala+'/signals');
onChildAdded(allSignalsRef, snapshot=>{
  const peerId = snapshot.key;
  if(peerId===user.uid) return;
  const data = snapshot.val();
  if(data.type==='offer') handleOffer(peerId, data);
  else if(data.type==='answer') handleAnswer(peerId, data);
  else if(data.type==='ice') handleICE(peerId, data.candidate);
});

async function createConnection(peerId){
  if(localConnections[peerId]) return localConnections[peerId];
  const pc = new RTCPeerConnection(peerConfig);
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  pc.ontrack = e=>{
    const stream = e.streams[0];
    remoteStreams[peerId]=stream;
    if(!videoElements[peerId]) videosDiv.appendChild(addVideo(peerId,stream,false));
    else videoElements[peerId].querySelector('video').srcObject=stream;
  };

  pc.onicecandidate = e=>{
    if(e.candidate){
      set(ref(db,'salas/'+codigoSala+'/signals/'+peerId+'/ice_'+user.uid),{type:'ice',candidate:e.candidate});
    }
  };

  localConnections[peerId]=pc;
  return pc;
}

async function handleOffer(peerId,data){
  const pc = await createConnection(peerId);
  await pc.setRemoteDescription(data.offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  set(ref(db,'salas/'+codigoSala+'/signals/'+peerId+'/answer_'+user.uid),{type:'answer',answer:answer});
}

async function handleAnswer(peerId,data){
  const pc = localConnections[peerId];
  if(!pc) return;
  await pc.setRemoteDescription(data.answer);
}

async function handleICE(peerId,candidate){
  const pc = localConnections[peerId];
  if(pc) pc.addIceCandidate(candidate);
}

// Crear oferta para nuevos usuarios
onChildAdded(salaUsuariosRef,snapshot=>{
  const uid = snapshot.key;
  if(uid===user.uid) return;
  createConnection(uid).then(async pc=>{
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    set(ref(db,'salas/'+codigoSala+'/signals/'+uid+'/offer_'+user.uid),{type:'offer',offer:offer});
  });
});
</script>

<style>
.video-container { position:relative; background:#222; border-radius:12px; overflow:hidden; display:flex; justify-content:center; align-items:center; transition: all 0.3s; }
.video-container video { width:100%; height:100%; object-fit:cover; }
.username { position:absolute; bottom:4px; left:4px; background:rgba(0,0,0,0.6); padding:2px 6px; border-radius:6px; font-size:12px; }
.name-placeholder { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:16px; font-weight:bold; color:#bbb; height:100%; width:100%; }
.avatar { width:50px; height:50px; border-radius:50%; margin-bottom:5px; background:#555; display:flex; align-items:center; justify-content:center; font-size:24px; }
.controls { display:flex; justify-content:center; gap:10px; padding:10px; background:#1c1c2e; }
button.video-btn { background:#3a3a50; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:14px; transition:background 0.3s; }
button.video-btn:hover { background:#56567a; }
#videos { display:grid; grid-template-columns:repeat(2,1fr); grid-auto-rows:200px; gap:10px; padding:10px; }
#extraUsers { display:none; flex-wrap:wrap; gap:10px; padding:10px; background:#111; max-height:200px; overflow-y:auto; }
body.muted { background:#2a0f0f; }
</style>
</head>
<body>
<header>
<img src="Naio.png" alt="Logo Naio" style="height:35px; margin-right:12px;">
Naio - Sala <span id="salaCodigo"></span>
</header>

<div id="videos"></div>
<div id="extraUsers"></div>

<div class="controls">
<button id="toggleCamera" class="video-btn">ðŸ“· CÃ¡mara</button>
<button id="toggleMic" class="video-btn">ðŸŽ¤ MicrÃ³fono</button>
<button id="showMore" class="video-btn hidden">MÃ¡s</button>
</div>
</body>
</html>
