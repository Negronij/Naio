<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Naio - Llamada</title>
<link rel="icon" href="Naio.png">
<style>
body { margin:0; font-family:Arial; background:#0f0f1a; color:#fff; display:flex; flex-direction:column; height:100vh; transition:background 0.3s; }
body.muted { background:#2a0f0f; }

header { display:flex; align-items:center; padding:10px 20px; background:#1c1c2e; font-size:22px; font-weight:bold; }
header img { height:35px; margin-right:12px; }

#videos-container { flex:1; display:flex; flex-direction:column; overflow:hidden; }
#videos { display:grid; gap:10px; padding:10px; box-sizing:border-box; flex-shrink:0; }
.video-container { position:relative; background:#222; border-radius:12px; overflow:hidden; display:flex; justify-content:center; align-items:center; }
.video-container video { width:100%; height:100%; object-fit:cover; border-radius:12px; }
.name-placeholder { position:absolute; font-size:16px; font-weight:bold; color:#bbb; display:flex; justify-content:center; align-items:center; width:100%; height:100%; text-align:center; }
.username { position:absolute; bottom:4px; left:4px; background:rgba(0,0,0,0.6); padding:2px 6px; border-radius:6px; font-size:12px; }

.controls { position:fixed; bottom:0; left:0; width:100%; display:flex; justify-content:center; gap:20px; padding:10px; background:#1c1c2e; z-index:10; }
button.video-btn { 
  background:#3a3a50; width:60px; height:60px; border-radius:50%; border:none; cursor:pointer; display:flex; justify-content:center; align-items:center; padding:0; transition:background 0.3s; 
}
button.video-btn:hover { background:#56567a; }
button.video-btn img { width:36px; height:36px; }

#joinBtn { margin:10px auto; padding:10px 20px; font-size:16px; cursor:pointer; }

#extra-users { display:flex; overflow-x:auto; gap:10px; padding:10px; display:none; }
#extra-users .video-container { min-width:150px; min-height:150px; flex-shrink:0; }
#more-btn { margin:10px auto; padding:5px 12px; cursor:pointer; font-size:14px; background:#3a3a50; border:none; border-radius:6px; color:#fff; }
</style>
</head>
<body>

<header>
<img src="Naio.png" alt="Logo Naio">
Naio - Sala <span id="salaCodigo"></span>
</header>

<div id="videos-container">
  <div id="videos"></div>
  <div id="extra-users"></div>
</div>

<div class="controls">
  <button id="toggleCamera" class="video-btn"><img src="cam.png"></button>
  <button id="toggleMic" class="video-btn"><img src="mic.png"></button>
</div>

<button id="joinBtn">🔴 Unirse a la llamada</button>
<button id="more-btn" class="hidden">+ Más</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCmzxzDSJFPt7-fDti1PRC-boDE30cJEbM",
  authDomain: "naio1092ngs.firebaseapp.com",
  projectId: "naio1092ngs",
  storageBucket: "naio1092ngs.firebasestorage.app",
  messagingSenderId: "874452485775",
  appId: "1:874452485775:web:25e5ed586fcebe93e952fa",
  measurementId: "G-JBK153N8XL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let user, localStream;
const peers = {};
const cameras = {};
let camOn = true, micOn = true;

const videosDiv = document.getElementById('videos');
const extraDiv = document.getElementById('extra-users');
const toggleCameraBtn = document.getElementById('toggleCamera');
const toggleMicBtn = document.getElementById('toggleMic');
const joinBtn = document.getElementById('joinBtn');
const moreBtn = document.getElementById('more-btn');

const urlParams = new URLSearchParams(window.location.search);
const codigoSala = urlParams.get('codigo');
if(!codigoSala) alert("Código de sala no especificado");
document.getElementById('salaCodigo').textContent = codigoSala;

// Login
auth.onAuthStateChanged(u=>{
  if(!u){ alert("Debes iniciar sesión"); window.location.href="index.html"; }
  else user = u;
});

// Función agregar video
function addVideo(uid, nombre, stream=null, isLocal=false){
  if(cameras[uid]) return cameras[uid];
  const container = document.createElement('div');
  container.classList.add('video-container');

  const vid = document.createElement('video');
  vid.autoplay = true;
  vid.playsInline = true;
  vid.muted = isLocal;
  if(stream) vid.srcObject = stream;
  container.appendChild(vid);

  const usernameDiv = document.createElement('div');
  usernameDiv.classList.add('username');
  usernameDiv.textContent = nombre;
  container.appendChild(usernameDiv);

  const namePlaceholder = document.createElement('div');
  namePlaceholder.classList.add('name-placeholder');
  namePlaceholder.textContent = nombre;
  if(!stream) namePlaceholder.style.display = 'flex';
  container.appendChild(namePlaceholder);

  cameras[uid] = { container, vid, namePlaceholder };

  updateGrid();
  return cameras[uid];
}

// Actualizar grid para mostrar hasta 4 y resto en carrusel
function updateGrid(){
  const keys = Object.keys(cameras);
  videosDiv.innerHTML = '';
  extraDiv.innerHTML = '';
  keys.forEach((uid,i)=>{
    if(i<4) videosDiv.appendChild(cameras[uid].container);
    else extraDiv.appendChild(cameras[uid].container);
  });
  extraDiv.style.display = extraDiv.childElementCount>0?'flex':'none';
  moreBtn.style.display = extraDiv.childElementCount>0?'block':'none';
  const cols = Math.min(2, Math.ceil(Math.min(4,keys.length)/2));
  videosDiv.style.gridTemplateColumns = `repeat(${cols},1fr)`;
});

// Botones cámara/mic
toggleCameraBtn.addEventListener('click', ()=>{
  if(!localStream) return;
  camOn = !camOn;
  localStream.getVideoTracks().forEach(t=>t.enabled=camOn);
  cameras[user.uid].vid.style.display = camOn?'block':'none';
  cameras[user.uid].namePlaceholder.style.display = camOn?'none':'flex';
  toggleCameraBtn.querySelector('img').src = camOn?'cam.png':'cam_off.png';
});

toggleMicBtn.addEventListener('click', ()=>{
  if(!localStream) return;
  micOn = !micOn;
  localStream.getAudioTracks().forEach(t=>t.enabled=micOn);
  document.body.classList.toggle('muted', !micOn);
  toggleMicBtn.querySelector('img').src = micOn?'mic.png':'mic_off.png';
});

// Unirse a la llamada
joinBtn.addEventListener('click', async ()=>{
  joinBtn.disabled = true;
  joinBtn.style.display = 'none';
  try {
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    cameras[user.uid].vid.srcObject = localStream;
    cameras[user.uid].namePlaceholder.style.display = camOn?'none':'flex';
    joinSala();
  } catch(e){
    alert("No se pudo acceder a cámara/micrófono: "+e.message);
  }
});

// Conectar sala
function joinSala(){
  const salaRef = ref(db, `salas/${codigoSala}/usuarios/${user.uid}`);
  set(salaRef,{name:user.displayName});
  window.addEventListener('beforeunload',()=>remove(salaRef));

  const usersRef = ref(db, `salas/${codigoSala}/usuarios`);
  onValue(usersRef, snapshot=>{
    const usuarios = snapshot.val() || {};
    for(let uid in usuarios){
      if(uid !== user.uid && !cameras[uid]) addVideo(uid, usuarios[uid].name);
      if(uid !== user.uid && !peers[uid]) createPeer(uid, !!localStream);
    }
  });
}

// Crear peer
function createPeer(remoteUid, isOffer){
  if(!localStream) return;
  const peer = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  localStream.getTracks().forEach(t=>peer.addTrack(t, localStream));

  peer.ontrack = event=>{
    addVideo(remoteUid,"Usuario",event.streams[0]);
  };

  peer.onicecandidate = e=>{
    if(e.candidate) push(ref(db, `salas/${codigoSala}/candidatos/${remoteUid}`), {from:user.uid, candidate:e.candidate.toJSON()});
  };

  peers[remoteUid] = peer;

  if(isOffer){
    peer.onnegotiationneeded = async ()=>{
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      set(ref(db, `salas/${codigoSala}/offers/${remoteUid}/${user.uid}`), offer.toJSON());
    };
  }
}

// Escuchar ofertas
const offersRef = ref(db, `salas/${codigoSala}/offers/${user.uid}`);
onValue(offersRef, snapshot=>{
  const data = snapshot.val() || {};
  for(let fromUid in data){
    const offer = data[fromUid];
    if(!peers[fromUid]) createPeer(fromUid,false);
    const peer = peers[fromUid];
    peer.setRemoteDescription(new RTCSessionDescription(offer)).then(async ()=>{
      const ans = await peer.createAnswer();
      await peer.setLocalDescription(ans);
      set(ref(db, `salas/${codigoSala}/answers/${fromUid}/${user.uid}`), ans.toJSON());
    });
  }
});

// Escuchar respuestas
const answersRef = ref(db, `salas/${codigoSala}/answers/${user.uid}`);
onValue(answersRef, snapshot=>{
  const data = snapshot.val() || {};
  for(let fromUid in data){
    if(peers[fromUid]) peers[fromUid].setRemoteDescription(new RTCSessionDescription(data[fromUid]));
  }
});

// Escuchar candidatos ICE
const candidatesRef = ref(db, `salas/${codigoSala}/candidatos/${user.uid}`);
onValue(candidatesRef, snapshot=>{
  const data = snapshot.val() || {};
  for(let id in data){
    const c = data[id];
    if(peers[c.from]) peers[c.from].addIceCandidate(new RTCIceCandidate(c.candidate));
  }
});

// Botón más
moreBtn.addEventListener('click', ()=>extraDiv.scrollBy({left:200, behavior:'smooth'}));

</script>

</body>
</html>
